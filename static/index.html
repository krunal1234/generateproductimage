<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Background Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.12.0/cdn.min.js"></script>
    <style>
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .preview-container {
            height: 400px;
            overflow: hidden;
            position: relative;
            background-color: #f0f0f0;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%),
                              linear-gradient(-45deg, #ccc 25%, transparent 25%),
                              linear-gradient(45deg, transparent 75%, #ccc 75%),
                              linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        .preview-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -18px;
            margin-left: -18px;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading .spinner {
            display: block;
        }
        .loading img {
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="imageProcessor()">
    <div class="app-container py-8 px-4">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-700">Image Background Management</h1>
            <p class="text-gray-600 mt-2">Upload an image, remove its background, or generate a new background</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left column: Upload and controls -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="file-upload">
                        Upload Image
                    </label>
                    <input
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        id="file-upload"
                        type="file"
                        accept="image/*"
                        @change="handleFileUpload"
                    >
                </div>

                <div class="mb-6" x-show="uploadedImage">
                    <button
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md mb-4 transition duration-300"
                        @click="removeBackground"
                        :disabled="isProcessing"
                        :class="{'opacity-50 cursor-not-allowed': isProcessing}"
                    >
                        Remove Background
                    </button>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="background-prompt">
                        Background Prompt
                    </label>
                    <textarea
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        id="background-prompt"
                        rows="3"
                        placeholder="Describe the background you want to generate..."
                        x-model="backgroundPrompt"
                    ></textarea>
                </div>

                <div class="mb-6">
                    <button
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300"
                        @click="generateBackground"
                        :disabled="!backgroundPrompt || isProcessing"
                        :class="{'opacity-50 cursor-not-allowed': !backgroundPrompt || isProcessing}"
                    >
                        Generate Background
                    </button>
                </div>

                <div class="mb-6" x-show="processedImageUrl">
                    <button
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-md transition duration-300"
                        @click="downloadImage"
                    >
                        Download Image
                    </button>
                </div>
            </div>

            <!-- Right column: Preview -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Preview</h2>
                <div class="preview-container rounded-lg" :class="{'loading': isProcessing}">
                    <div class="spinner"></div>
                    <img 
                        x-show="previewImage" 
                        :src="previewImage" 
                        alt="Preview"
                    >
                    <div 
                        x-show="!previewImage" 
                        class="flex items-center justify-center h-full text-gray-500"
                    >
                        Upload an image or generate a background to see preview
                    </div>
                </div>
                <div class="mt-4 text-center text-sm text-gray-600" x-show="processedImageUrl">
                    <p>Click 'Download Image' to save the result</p>
                </div>
            </div>
        </div>

        <div class="mt-8 text-center text-gray-600 text-sm">
            <p>This application uses AI to remove image backgrounds and generate new ones.</p>
        </div>
    </div>

    <script>
        function imageProcessor() {
            return {
                uploadedImage: null,
                uploadedImageUrl: null,
                processedImageUrl: null,
                previewImage: null,
                backgroundPrompt: '',
                isProcessing: false,
                
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.uploadedImage = file;
                        this.uploadedImageUrl = URL.createObjectURL(file);
                        this.previewImage = this.uploadedImageUrl;
                        this.processedImageUrl = null;
                    }
                },
                
                async removeBackground() {
                    if (!this.uploadedImage) {
                        alert('Please upload an image first');
                        return;
                    }
                    
                    this.isProcessing = true;
                    
                    try {
                        const formData = new FormData();
                        formData.append('file', this.uploadedImage);
                        
                        const response = await fetch('/remove_background', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            this.processedImageUrl = result.url;
                            this.previewImage = result.url;
                        } else {
                            alert('Error: ' + (result.error || 'Failed to process image'));
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('An error occurred while processing the image');
                    } finally {
                        this.isProcessing = false;
                    }
                },
                
                async generateBackground() {
                    if (!this.backgroundPrompt) {
                        alert('Please enter a background prompt');
                        return;
                    }
                    
                    this.isProcessing = true;
                    
                    try {
                        const response = await fetch(`/generate_background?background_prompt=${encodeURIComponent(this.backgroundPrompt)}`, {
                            method: 'POST'
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            this.processedImageUrl = result.url;
                            this.previewImage = result.url;
                        } else {
                            alert('Error: ' + (result.error || 'Failed to generate background'));
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('An error occurred while generating the background');
                    } finally {
                        this.isProcessing = false;
                    }
                },
                
                downloadImage() {
                    if (this.processedImageUrl) {
                        const link = document.createElement('a');
                        link.href = this.processedImageUrl;
                        link.download = 'processed-image.png';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                }
            };
        }
    </script>
</body>
</html>